---
# Ansible playbook for removing Pacemaker cluster configuration generated by sap_ha_pacemaker_cluster role
- name: Ansible Play to create dynamic inventory group
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Create dynamic inventory group
      ansible.builtin.include_tasks:
        file: ../tasks/prepare_inventory.yml

- name: Remove cluster configuration - Netweaver ASCS/ERS
  hosts: nwas_ascs_ers
  become: true
  any_errors_fatal: true
  max_fail_percentage: 0
  gather_facts: true
  vars:
    # Assignment of variables generated by sap_ha_pacemaker_cluster
    sap_ha_pacemaker_cluster_nwas_abap_ascs_sapinstance_instance_name:
      "{{ sap_system_sid }}_ASCS{{ sap_system_nwas_ascs_instance_nr }}_{{ sap_swpm_ascs_instance_hostname }}"
    sap_ha_pacemaker_cluster_nwas_abap_ascs_sapinstance_start_profile_string: "/sapmnt/{{ sap_system_sid }}/profile/{{ sap_system_sid
      }}_ASCS{{ sap_system_nwas_ascs_instance_nr }}_{{ sap_swpm_ascs_instance_hostname }}"  # noqa jinja[spacing]

    sap_ha_pacemaker_cluster_nwas_abap_ers_sapinstance_instance_name:
      "{{ sap_system_sid }}_ERS{{ sap_system_nwas_ers_instance_nr }}_{{ sap_swpm_ers_instance_hostname }}"
    sap_ha_pacemaker_cluster_nwas_abap_ers_sapinstance_start_profile_string: "/sapmnt/{{ sap_system_sid }}/profile/{{ sap_system_sid
      }}_ERS{{ sap_system_nwas_ers_instance_nr }}_{{ sap_swpm_ers_instance_hostname }}"  # noqa jinja[spacing]
    sap_ha_pacemaker_cluster_nwas_ascs_ers_profile_paths:
      - "{{ sap_ha_pacemaker_cluster_nwas_abap_ascs_sapinstance_start_profile_string }}"
      - "{{ sap_ha_pacemaker_cluster_nwas_abap_ers_sapinstance_start_profile_string }}"
  tasks:

    - name: Get stat of cluster configuration files
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /etc/corosync/corosync.conf
        - /var/lib/pacemaker/cib/cib.xml
      register: ha_cluster_config_files_stat

    - name: Stop cluster
      ansible.builtin.command:
        cmd: "{{ 'pcs' if ansible_os_family == 'RedHat' else 'crm' }} cluster stop"
      when: not ha_cluster_config_files_stat.results |
        selectattr('stat.exists', 'equalto', false) | list | length > 0
      changed_when: true

    - name: Populate service facts
      ansible.builtin.service_facts:

    # Conditional added to skip qdevice in case qdevice was not configured
    - name: Stop cluster daemons
      ansible.builtin.service:
        name: "{{ item }}"
        state: stopped  # noqa no-handler
      loop:
        - pacemaker.service
        - corosync.service
        - corosync-qdevice.service
      when: item in ansible_facts.services

    - name: Remove cluster configuration files
      ansible.builtin.file:
        path: "{{ config_file.item }}"
        state: absent
      loop: "{{ ha_cluster_config_files_stat.results }}"
      loop_control:
        loop_var: config_file
      when: config_file.stat.exists

    # Removal using file module is too slow.
    - name: Remove all files in /var/lib/pacemaker/cib/
      ansible.builtin.shell:
        cmd: 'rm -f /var/lib/pacemaker/cib/{cib*,shadow*}'
      changed_when: true

    - name: Remove HAlib configuration
      ansible.builtin.lineinfile:
        path: "{{ item }}"
        state: absent
        regexp: '^service/halib'
      loop: "{{ sap_ha_pacemaker_cluster_nwas_ascs_ers_profile_paths }}"


- name: Remove cluster configuration - Netweaver SCS/ERS
  hosts: nwas_scs_ers
  become: true
  any_errors_fatal: true
  max_fail_percentage: 0
  gather_facts: true
  vars:
    # Assignment of variables generated by sap_ha_pacemaker_cluster
    # sap_ha_pacemaker_cluster_nwas_scs_sapinstance_instance_name:
    #   "{{ sap_system_sid }}_ASCS{{ sap_system_nwas_ascs_instance_nr }}_{{ sap_swpm_ascs_instance_hostname }}"
    # sap_ha_pacemaker_cluster_nwas_scs_sapinstance_start_profile_string:
    #   "/sapmnt/{{ sap_system_sid }}/profile/{{ sap_system_sid }}_ASCS{{ sap_system_nwas_ascs_instance_nr }}_{{ sap_swpm_ascs_instance_hostname }}"

    # sap_ha_pacemaker_cluster_nwas_abap_ers_sapinstance_instance_name:
    #   "{{ sap_system_sid }}_ERS{{ sap_system_nwas_ers_instance_nr }}_{{ sap_swpm_ers_instance_hostname }}"
    # sap_ha_pacemaker_cluster_nwas_abap_ers_sapinstance_start_profile_string:
    #   "/sapmnt/{{ sap_system_sid }}/profile/{{ sap_system_sid }}_ERS{{ sap_system_nwas_ers_instance_nr }}_{{ sap_swpm_ers_instance_hostname }}"
    sap_ha_pacemaker_cluster_nwas_scs_sapinstance_instance_name:
      "{{ sap_system_sid }}_SCS{{ sap_system_nwas_scs_instance_nr }}_{{ sap_swpm_java_scs_instance_hostname }}"
    sap_ha_pacemaker_cluster_nwas_scs_sapinstance_start_profile_string:
      "/sapmnt/{{ sap_system_sid }}/profile/{{ sap_ha_pacemaker_cluster_nwas_scs_sapinstance_instance_name }}"

    sap_ha_pacemaker_cluster_nwas_ers_sapinstance_instance_name:
      "{{ sap_system_sid }}_ERS{{ sap_system_nwas_ers_instance_nr }}_{{ sap_swpm_ers_instance_hostname }}"
    sap_ha_pacemaker_cluster_nwas_ers_sapinstance_start_profile_string:
      "/sapmnt/{{ sap_system_sid }}/profile/{{ sap_ha_pacemaker_cluster_nwas_ers_sapinstance_instance_name }}"

    sap_ha_pacemaker_cluster_nwas_scs_ers_profile_paths:
      - "{{ sap_ha_pacemaker_cluster_nwas_scs_sapinstance_start_profile_string }}"
      - "{{ sap_ha_pacemaker_cluster_nwas_ers_sapinstance_start_profile_string }}"
  tasks:

    - name: Get stat of cluster configuration files
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /etc/corosync/corosync.conf
        - /var/lib/pacemaker/cib/cib.xml
      register: ha_cluster_config_files_stat

    - name: Stop cluster
      ansible.builtin.command:
        cmd: "{{ 'pcs' if ansible_os_family == 'RedHat' else 'crm' }} cluster stop"
      when: not ha_cluster_config_files_stat.results |
        selectattr('stat.exists', 'equalto', false) | list | length > 0
      changed_when: true

    - name: Populate service facts
      ansible.builtin.service_facts:

    # Conditional added to skip qdevice in case qdevice was not configured
    - name: Stop cluster daemons
      ansible.builtin.service:
        name: "{{ item }}"
        state: stopped  # noqa no-handler
      loop:
        - pacemaker.service
        - corosync.service
        - corosync-qdevice.service
      when: item in ansible_facts.services

    - name: Remove cluster configuration files
      ansible.builtin.file:
        path: "{{ config_file.item }}"
        state: absent
      loop: "{{ ha_cluster_config_files_stat.results }}"
      loop_control:
        loop_var: config_file
      when: config_file.stat.exists

    # Removal using file module is too slow.
    - name: Remove all files in /var/lib/pacemaker/cib/
      ansible.builtin.shell:
        cmd: 'rm -f /var/lib/pacemaker/cib/{cib*,shadow*}'
      changed_when: true

    - name: Remove HAlib configuration
      ansible.builtin.lineinfile:
        path: "{{ item }}"
        state: absent
        regexp: '^service/halib'
      loop: "{{ sap_ha_pacemaker_cluster_nwas_scs_ers_profile_paths }}"


- name: Remove cluster configuration - HANA Scale-up HA
  hosts: hana_primary, hana_secondary
  become: true
  any_errors_fatal: true
  max_fail_percentage: 0
  gather_facts: true
  vars:
    # Assignment of variables generated by sap_ha_pacemaker_cluster
    sap_ha_pacemaker_cluster_hana_global_ini_path: "/usr/sap/{{
      sap_system_hana_db_sid | upper }}/SYS/global/hdb/custom/config/global.ini"
  tasks:

    - name: Get stat of cluster configuration files
      ansible.builtin.stat:
        path: "{{ item }}"
      loop:
        - /etc/corosync/corosync.conf
        - /var/lib/pacemaker/cib/cib.xml
      register: ha_cluster_config_files_stat

    - name: Stop cluster
      ansible.builtin.command:
        cmd: "{{ 'pcs' if ansible_os_family == 'RedHat' else 'crm' }} cluster stop"
      when: not ha_cluster_config_files_stat.results |
        selectattr('stat.exists', 'equalto', false) | list | length > 0
      changed_when: true

    - name: Populate service facts
      ansible.builtin.service_facts:

    # Conditional added to skip qdevice in case qdevice was not configured
    - name: Stop cluster daemons
      ansible.builtin.service:
        name: "{{ item }}"
        state: stopped  # noqa no-handler
      loop:
        - pacemaker.service
        - corosync.service
        - corosync-qdevice.service
      when: item in ansible_facts.services

    - name: Remove cluster configuration files
      ansible.builtin.file:
        path: "{{ config_file.item }}"
        state: absent
      loop: "{{ ha_cluster_config_files_stat.results }}"
      loop_control:
        loop_var: config_file
      when: config_file.stat.exists

    # Removal using file module is too slow.
    - name: Remove all files in /var/lib/pacemaker/cib/
      ansible.builtin.shell:
        cmd: 'rm -f /var/lib/pacemaker/cib/{cib*,shadow*}'
      changed_when: true

    - name: Check presence of global.ini
      ansible.builtin.stat:
        path: "{{ sap_ha_pacemaker_cluster_hana_global_ini_path }}"
      register: sap_ha_pacemaker_cluster_global_ini
      failed_when: not sap_ha_pacemaker_cluster_global_ini.stat.exists

    - name: Remove ha_dr_provider blocks from global.ini
      ansible.builtin.replace:
        path: "{{ sap_ha_pacemaker_cluster_hana_global_ini_path }}"
        regexp: '^\[ha_dr_provider.*\][^[]+'
        replace: ''
      when: sap_ha_pacemaker_cluster_global_ini.stat.exists

    - name: Remove trace block from global.ini  # noqa risky-file-permissions
      community.general.ini_file:
        path: "{{ sap_ha_pacemaker_cluster_hana_global_ini_path }}"
        section: "trace"
        state: absent
      when: sap_ha_pacemaker_cluster_global_ini.stat.exists

    - name: Delete srhook sudoers file
      ansible.builtin.file:
        path: /etc/sudoers.d/20-saphana
        state: absent
